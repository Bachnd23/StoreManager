@page
@using System.Globalization
@using System.Text.Json
<!DOCTYPE html>
<html lang="en">
<body>
    <div class="container-fluid">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item active" aria-current="page">Danh sách khách hàng</li>
            </ol>
        </nav>
        <div class="row g-4">
            <div class="col-sm-12 col-xl-12">
                <div class="bg-light rounded h-100 p-4">
                    <div>
                        <h4 class="mb-4">Danh sách khách hàng</h4>
                    </div>
                    <div class="row g-4 input-group">
                        <div class="col-sm-4">
                            <input class="form-control border-0 nameQuery" type="search" name="nameQuery" placeholder="Search">
                        </div>
                        <div class="col-sm-4">
                            <button type="button" class="btn btn-primary" onclick="search()">Search</button>
                        </div>
                    </div>
                    <div class="g-4 input-group flex-nowrap justify-content-end">
                        <a href="~/Customer/Add" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i>
                        </a>
                    </div>
                    <div>
                        <table class="table table-striped w-100 resultTable">
                            <thead>
                                <tr>
                                    <th scope="col">Khách hàng</th>
                                    <th scope="col">Địa chỉ</th>
                                    <th scope="col">Số điện thoại</th>
                                    <th scope="col">Trạng thái</th>
                                    <th scope="col">Hành động</th>
                                </tr>
                            </thead>
                            <tbody class="resultTableBody">
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="g-4 input-group flex-nowrap justify-content-end paginationContainer">
                        <div class="input-group flex-nowrap justify-content-end pe-3">
                            <div class="pageNumber">1</div> /
                            <div class="totalPages"></div>&nbsp;rows
                        </div>
                        <a onclick="prevPage()" class="prevPage pe-1"><i class="fas fa-chevron-left"></i></a>
                        <a onclick="nextPage()" class="nextPage ps-1 pe-3"><i class="fas fa-chevron-right"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @section Scripts {
        <script>
            var nameQuery = "";
            var roleId = "";
            var pageNumber = 1;
            var totalPages = 1;
            var isFetchingData = false;

            $(document).ready(function () {
                fetchCustomersResults();
            });

            function nextPage() {
                if (pageNumber < totalPages && !isFetchingData) {
                    pageNumber++;
                    fetchCustomersResults();
                }
            }

            function prevPage() {
                if (pageNumber > 1 && !isFetchingData) {
                    pageNumber--;
                    fetchCustomersResults();
                }
            }

            function search() {
                pageNumber = 1;
                fetchCustomersResults();
            }

            function fetchCustomersResults() {
                nameQuery = $('.nameQuery').val();
                isFetchingData = true;
                $.ajax({
                    url: '@Url.Action("List", "Customer")',
                    dataType: "json",
                    type: 'GET',
                    data: {
                        nameQuery: nameQuery,
                        pageNumber: pageNumber
                    },
                    success: function (data) {
                        generateCustomersTable(data);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching offer results:', error);
                    },
                    complete: function () {
                        isFetchingData = false; // Reset the flag after data fetch is complete
                    }
                });
            }

            function generateCustomersTable(data) {
                // Update the pagination information
                pageNumber = data.pageNumber;
                totalPages = data.totalPages;

                // If current page out of range, then move current page to last range and retrieve data again
                if (pageNumber > totalPages) {
                    pageNumber = totalPages;
                    fetchCustomersResults();
                    return;
                }

                $('.pageNumber').html(pageNumber);
                $('.totalPages').html(totalPages);

                // Hide the previous page button if the current page is the first page
                if (pageNumber === 1 || pageNumber === 0) {
                    $('.prevPage').hide();
                } else {
                    $('.prevPage').show();
                }

                // Hide the next page button if the current page is the last page
                if (pageNumber === totalPages) {
                    $('.nextPage').hide();
                } else {
                    $('.nextPage').show();
                }

                // Clear the existing table body
                $('.resultTableBody').empty();

                // Check if there is no data
                if (data.customerResults.length === 0) {
                    $('.resultTableBody').append('<tr><td colspan="7"><p>No result found</p></td></tr>');
                    return;
                }

                // Iterate over the user results and create table rows
                $.each(data.customerResults, function (index, customer) {
                    const row = $('<tr>');
                    row.append($('<td>').text(customer.name));
                    row.append($('<td>').text(customer.address));
                    row.append($('<td>').text(customer.phone));
                    if (customer.active) {
                        row.append($('<td>').text('Đã kích hoạt'));
                    } else {
                        row.append($('<td>').text('Chưa kích hoạt'));
                    }

                    const actionCell = $('<td>');
                    const viewButton = $('<a>', {
                        href: '#',
                        class: 'btn btn-sm btn-primary ps-2',
                        html: '<i class="fas fa-eye"></i>'
                    });
                    const editButton = $('<a>', {
                        href: '#',
                        class: 'btn btn-sm btn-primary ps-2',
                        html: '<i class="fas fa-pen"></i>'
                    });
                    actionCell.append($('<div>', { class: 'input-group flex-nowrap' })
                        .append($('<div>', { class: 'ps-2' }).append(viewButton))
                        .append($('<div>', { class: 'ps-2' }).append(editButton)));
                    row.append(actionCell);

                    $('.resultTableBody').append(row);
                });
            }
        </script>
    }
</body>
</html>
